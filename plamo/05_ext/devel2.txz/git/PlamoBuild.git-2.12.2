#!/bin/sh

######################################################################
pkgbase=git
vers=2.12.2
url="https://www.kernel.org/pub/software/scm/git/git-${vers}.tar.gz
    https://www.kernel.org/pub/software/scm/git/git-manpages-${vers}.tar.gz
    ftp://plamo.linet.gr.jp/pub/Plamo-src/plamo/05_ext/devel2.txz/git/git-set-file-times"
verify=
digest=
commitid=
arch=`uname -m`
build=P1
src=$pkgbase-$vers
patchfiles=""
OPT_CONFIG=""
DOCS="COPYING INSTALL LGPL-2.1 README.md RelNotes command-list.txt"
template=20170415
tmplurl=ftp://plamo.linet.gr.jp/pub/Plamo-src/admin
######################################################################

if [ -f functions ] ; then
  source ./functions
elif [ ! -f /usr/share/plamo/functions ] ; then
  wget ftp://plamo.linet.gr.jp/pub/Plamo-src/admin/functions
  source ./functions
else
  source /usr/share/plamo/functions
fi

fscheck
prepare "$@"
if [ $opt_download -eq 1 ] ; then
  download_sources
fi
if [ $opt_config -eq 1 ] ; then
  for i in `seq 0 $((${#B[@]} - 1))` ; do
    if [ -d ${B[$i]} ] ; then rm -rf ${B[$i]} ; fi ; cp -a ${S[$i]} ${B[$i]}
  done
  apply_patches
  for i in `seq 0 $((${#B[@]} - 1))` ; do
    cd ${B[$i]}
    if [ -x configure ] ; then
      ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var \
          --libdir='${exec_prefix}'/$libdir --infodir='${prefix}'/share/info \
          --mandir='${prefix}'/share/man ${OPT_CONFIG[$i]}
    fi
  done
fi
if [ $opt_build -eq 1 ] ; then
  for i in `seq 0 $((${#B[@]} - 1))` ; do
    cd ${B[$i]}
    if [ -f Makefile ] ; then
      make
    fi
  done
fi
if [ $opt_package -eq 1 ] ; then
  root_priv
  if [ -d $P ] ; then rm -rf $P ; fi ; mkdir -p $P
  if [ -d $C ] ; then rm -rf $C ; fi ; mkdir -p $C
  touch $W/i.st ; sleep 1
  for i in `seq 0 $((${#B[@]} - 1))` ; do
    cd ${B[$i]}
    if [ -f Makefile ] ; then
      make install DESTDIR=$P
    fi
  done
  install $W/git-set-file-times $P/usr/libexec/git-core
  find $P/usr/share/git-core/templates -exec touch {} \;
  touch $P/usr/share/locale/*/LC_MESSAGES/git.mo $mandir/man3/*
  cp -a $W/man[157] $mandir
  chown -R root.root $mandir/man[157]
  touch $W/i.et
  cd $W
  find $P ! -type l -newer i.st ! -newer i.et \
      -exec touch -t `date '+%m%d0900'` {} \;
  compress
  strip_bindir $P/usr/libexec/git-core
  touch -t `date '+%m%d0900'` $P/usr/libexec/git-core
  setup_docdir
  convert_links
  tar cvpf $pkg.tar -C $P `cd $P ; find usr/bin | tail -n+2`
  tar rvpf $pkg.tar -C $P usr/libexec/git-core
  tar rvpf $pkg.tar -C $P \
      usr/$libdir/perl5/site_perl/5.14.2/{Git,{Error,Git}.pm}
  tar rvpf $pkg.tar -C $P \
      `cd $P
      find usr/$libdir/perl5/site_perl/5.14.2/*-linux-thread-multi/auto \
      -maxdepth 1 | tail -n+2`
  tar rvpf $pkg.tar -C $P \
      `cd $P ; find usr/$libdir/perl5/5.14.2/*-linux-thread-multi | tail -n+2`
  tar rvpf $pkg.tar -C $P usr/share/git-core
  tar rvpf $pkg.tar -C $P `cd $P ; find usr/share/locale -name *.mo`
  tar rvpf $pkg.tar -C $P usr/share/git{web,k,-gui}
  tar rvpf $pkg.tar -C $P `cd $P ; find usr/share/man/man1 | tail -n+2`
  tar rvpf $pkg.tar -C $P `cd $P ; find usr/share/man/man3 | tail -n+2`
  tar rvpf $pkg.tar -C $P `cd $P ; find usr/share/man/man5 | tail -n+2`
  tar rvpf $pkg.tar -C $P `cd $P ; find usr/share/man/man7 | tail -n+2`
  tar rvpf $pkg.tar -C $P usr/share/doc/$src
  touch -t `date '+%m%d0900'` $pkg.tar ; xz $pkg.tar ; touch $pkg.tar.xz
  mv $pkg.tar.xz $pkg.txz
  cleanup
fi
